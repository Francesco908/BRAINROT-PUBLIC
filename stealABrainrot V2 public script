-- SPEED COIL ULTIMATE SYSTEM - Script Completo
-- Metti questo script in StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- Configurazione
local BOOST_SPEED = 145
local DEFAULT_SPEED = 80
local SPEED_COIL_NAME = "Speed Coil"
local systemEnabled = false

-- Crea GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SpeedCoilSystemGUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true

-- Frame principale
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 120)
mainFrame.Position = UDim2.new(0.5, -125, 0.5, -60)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

-- Bordi arrotondati
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = mainFrame

-- Titolo
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -40, 0, 30)
titleLabel.Position = UDim2.new(0, 0, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Speed Coil System"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.Parent = mainFrame

-- Pulsante chiudi
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 30, 0, 30)
closeButton.Position = UDim2.new(1, -35, 0, 5)
closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextScaled = true
closeButton.Font = Enum.Font.SourceSansBold
closeButton.Parent = mainFrame

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 5)
closeCorner.Parent = closeButton

-- Pulsante toggle
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0.8, 0, 0, 40)
toggleButton.Position = UDim2.new(0.1, 0, 0.5, -10)
toggleButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
toggleButton.Text = "ATTIVA"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.Parent = mainFrame

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 8)
toggleCorner.Parent = toggleButton

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, 0, 0, 20)
statusLabel.Position = UDim2.new(0, 0, 1, -25)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Sistema Disattivato"
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.SourceSans
statusLabel.Parent = mainFrame

screenGui.Parent = player:WaitForChild("PlayerGui")

-- Funzioni principali
local function findSpeedCoil()
    -- Cerca nel backpack
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, item in pairs(backpack:GetChildren()) do
            if item:IsA("Tool") and item.Name == SPEED_COIL_NAME then
                return item
            end
        end
    end
    
    -- Cerca nel character
    local character = player.Character
    if character then
        for _, item in pairs(character:GetChildren()) do
            if item:IsA("Tool") and item.Name == SPEED_COIL_NAME then
                return item
            end
        end
    end
    
    return nil
end

local function forceSpeed(humanoid, speed)
    humanoid.WalkSpeed = speed
    -- Protezione multipla
    local connections = {}
    
    connections[1] = humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
        if systemEnabled and humanoid.WalkSpeed ~= speed then
            humanoid.WalkSpeed = speed
        end
    end)
    
    -- Protezione contro StateChanged
    connections[2] = humanoid.StateChanged:Connect(function()
        if systemEnabled then
            humanoid.WalkSpeed = speed
        end
    end)
    
    -- Cleanup connections quando il character muore
    humanoid.Died:Connect(function()
        for _, conn in pairs(connections) do
            if conn then conn:Disconnect() end
        end
    end)
end

local function processSpeedCoil()
    if not systemEnabled then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local speedCoil = findSpeedCoil()
    
    if speedCoil then
        -- Se è nel backpack, equipaggiala
        if speedCoil.Parent == player.Backpack then
            humanoid:EquipTool(speedCoil)
        end
        
        -- Se è equipaggiata, applica boost
        if speedCoil.Parent == character then
            forceSpeed(humanoid, BOOST_SPEED)
            statusLabel.Text = "Speed Boost Attivo!"
            statusLabel.TextColor3 = Color3.fromRGB(50, 255, 50)
        end
    else
        -- Nessuna coil trovata, velocità normale
        humanoid.WalkSpeed = DEFAULT_SPEED
        statusLabel.Text = "Speed Coil non trovata"
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 50)
    end
end

-- Sistema di monitoraggio continuo
local monitorConnection
local function startMonitoring()
    if monitorConnection then monitorConnection:Disconnect() end
    
    monitorConnection = RunService.Heartbeat:Connect(function()
        if systemEnabled then
            processSpeedCoil()
        end
    end)
end

-- Gestione character respawn
player.CharacterAdded:Connect(function(character)
    wait(0.5) -- Attendi che il character sia completamente caricato
    
    if systemEnabled then
        startMonitoring()
        
        -- Aggiungi listener per tool changes
        character.ChildAdded:Connect(function(child)
            if child:IsA("Tool") and systemEnabled then
                processSpeedCoil()
            end
        end)
        
        character.ChildRemoved:Connect(function(child)
            if child:IsA("Tool") and child.Name == SPEED_COIL_NAME and systemEnabled then
                local humanoid = character:FindFirstChild("Humanoid")
                if humanoid then
                    humanoid.WalkSpeed = DEFAULT_SPEED
                end
            end
        end)
    end
end)

-- Toggle button
toggleButton.MouseButton1Click:Connect(function()
    systemEnabled = not systemEnabled
    
    if systemEnabled then
        toggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        toggleButton.Text = "DISATTIVA"
        statusLabel.Text = "Sistema Attivato"
        statusLabel.TextColor3 = Color3.fromRGB(50, 255, 50)
        startMonitoring()
    else
        toggleButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        toggleButton.Text = "ATTIVA"
        statusLabel.Text = "Sistema Disattivato"
        statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
        
        if monitorConnection then 
            monitorConnection:Disconnect() 
        end
        
        -- Reset speed
        local character = player.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = DEFAULT_SPEED
            end
        end
    end
end)

-- Close button
closeButton.MouseButton1Click:Connect(function()
    screenGui.Enabled = not screenGui.Enabled
end)

-- Hotkey per riaprire (F per aprire/chiudere)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.F then
        screenGui.Enabled = not screenGui.Enabled
    end
end)

-- Anti-exploit protection
spawn(function()
    while wait(0.1) do
        if systemEnabled and player.Character then
            local humanoid = player.Character:FindFirstChild("Humanoid")
            if humanoid then
                local speedCoil = findSpeedCoil()
                if speedCoil and speedCoil.Parent == player.Character then
                    if humanoid.WalkSpeed ~= BOOST_SPEED then
                        humanoid.WalkSpeed = BOOST_SPEED
                    end
                end
            end
        end
    end
end)

print("Speed Coil System caricato! Premi F per aprire/chiudere la GUI")
