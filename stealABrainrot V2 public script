-- SIGMA HUB - Advanced Parkour Script

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- Global variables
local deliveryPosition = nil
local isDragging = false
local isMinimized = false
local noclipEnabled = false
local noclipConnection = nil
local teleporting = false

-- Destroy existing GUI
if PlayerGui:FindFirstChild("SigmaHub") then
    PlayerGui.SigmaHub:Destroy()
end

-- TELEPORT SCREEN
local TeleportScreen = Instance.new("ScreenGui")
TeleportScreen.Name = "TeleportScreen"
TeleportScreen.DisplayOrder = 999999999
TeleportScreen.IgnoreGuiInset = true
TeleportScreen.Enabled = false
TeleportScreen.Parent = PlayerGui

local BlackScreen = Instance.new("Frame")
BlackScreen.Name = "BlackScreen"
BlackScreen.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BlackScreen.BorderSizePixel = 0
BlackScreen.Size = UDim2.new(1, 0, 1, 0)
BlackScreen.Parent = TeleportScreen

local TeleportText = Instance.new("TextLabel")
TeleportText.Name = "TeleportText"
TeleportText.BackgroundTransparency = 1
TeleportText.Position = UDim2.new(0, 0, 0.4, 0)
TeleportText.Size = UDim2.new(1, 0, 0.2, 0)
TeleportText.Font = Enum.Font.GothamBold
TeleportText.Text = "TELEPORTING..."
TeleportText.TextColor3 = Color3.fromRGB(255, 255, 255)
TeleportText.TextSize = 32
TeleportText.TextScaled = true
TeleportText.Parent = TeleportScreen

-- BYPASS FUNCTIONS (FIXED)
local function bypassAnticheat(character)
    if not character then return false end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    
    if not humanoid or not rootPart then return false end
    
    -- Disable physics temporarily
    rootPart.Anchored = true
    
    -- Clear velocity
    if rootPart:FindFirstChild("BodyVelocity") then
        rootPart.BodyVelocity:Destroy()
    end
    
    local bodyVel = Instance.new("BodyVelocity")
    bodyVel.MaxForce = Vector3.new(4000, 4000, 4000)
    bodyVel.Velocity = Vector3.new(0, 0, 0)
    bodyVel.Parent = rootPart
    
    return true
end

local function restoreCharacter(character)
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if rootPart then
        rootPart.Anchored = false
        
        -- Remove body velocity
        if rootPart:FindFirstChild("BodyVelocity") then
            rootPart.BodyVelocity:Destroy()
        end
    end
end

-- Create main ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SigmaHub"
ScreenGui.Parent = PlayerGui
ScreenGui.ResetOnSpawn = false

-- Main frame
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -90)
MainFrame.Size = UDim2.new(0, 300, 0, 180)
MainFrame.Active = true
MainFrame.ClipsDescendants = true

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

local Border = Instance.new("UIStroke")
Border.Color = Color3.fromRGB(138, 43, 226)
Border.Thickness = 3
Border.Transparency = 0.2
Border.Parent = MainFrame

-- Header
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.Parent = MainFrame
Header.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
Header.BorderSizePixel = 0
Header.Size = UDim2.new(1, 0, 0, 35)
Header.Active = true

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 12)
HeaderCorner.Parent = Header

local HeaderFix = Instance.new("Frame")
HeaderFix.Parent = Header
HeaderFix.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
HeaderFix.BorderSizePixel = 0
HeaderFix.Position = UDim2.new(0, 0, 0.7, 0)
HeaderFix.Size = UDim2.new(1, 0, 0.3, 0)

-- Titolo
local Title = Instance.new("TextLabel")
Title.Parent = Header
Title.BackgroundTransparency = 1
Title.Position = UDim2.new(0, 15, 0, 0)
Title.Size = UDim2.new(1, -80, 1, 0)
Title.Font = Enum.Font.GothamBold
Title.Text = "‚ö° SIGMA HUB"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left

-- Minimizza
local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Parent = Header
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
MinimizeBtn.BorderSizePixel = 0
MinimizeBtn.Position = UDim2.new(1, -60, 0.5, -10)
MinimizeBtn.Size = UDim2.new(0, 20, 0, 20)
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.Text = "‚àí"
MinimizeBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
MinimizeBtn.TextSize = 16

local MinCorner = Instance.new("UICorner")
MinCorner.CornerRadius = UDim.new(0, 4)
MinCorner.Parent = MinimizeBtn

-- Chiudi
local CloseBtn = Instance.new("TextButton")
CloseBtn.Parent = Header
CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
CloseBtn.BorderSizePixel = 0
CloseBtn.Position = UDim2.new(1, -35, 0.5, -10)
CloseBtn.Size = UDim2.new(0, 20, 0, 20)
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Text = "√ó"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 16

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 4)
CloseCorner.Parent = CloseBtn

-- Contenuto
local Content = Instance.new("Frame")
Content.Parent = MainFrame
Content.BackgroundTransparency = 1
Content.Position = UDim2.new(0, 0, 0, 40)
Content.Size = UDim2.new(1, 0, 1, -40)

-- Set Position Button
local SetDeliveryBtn = Instance.new("TextButton")
SetDeliveryBtn.Parent = Content
SetDeliveryBtn.BackgroundColor3 = Color3.fromRGB(46, 139, 87)
SetDeliveryBtn.BorderSizePixel = 0
SetDeliveryBtn.Position = UDim2.new(0.05, 0, 0.05, 0)
SetDeliveryBtn.Size = UDim2.new(0.9, 0, 0, 28)
SetDeliveryBtn.Font = Enum.Font.GothamBold
SetDeliveryBtn.Text = "üìç SET POSITION"
SetDeliveryBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
SetDeliveryBtn.TextSize = 12

local DeliveryCorner = Instance.new("UICorner")
DeliveryCorner.CornerRadius = UDim.new(0, 8)
DeliveryCorner.Parent = SetDeliveryBtn

-- Flying Teleport Button
local TeleportBtn = Instance.new("TextButton")
TeleportBtn.Parent = Content
TeleportBtn.BackgroundColor3 = Color3.fromRGB(65, 105, 225)
TeleportBtn.BorderSizePixel = 0
TeleportBtn.Position = UDim2.new(0.05, 0, 0.3, 0)
TeleportBtn.Size = UDim2.new(0.9, 0, 0, 35)
TeleportBtn.Font = Enum.Font.GothamBold
TeleportBtn.Text = "üåÄ FLY TO POSITION"
TeleportBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
TeleportBtn.TextSize = 12

local TeleCorner = Instance.new("UICorner")
TeleCorner.CornerRadius = UDim.new(0, 8)
TeleCorner.Parent = TeleportBtn

-- NoClip Button
local NoClipBtn = Instance.new("TextButton")
NoClipBtn.Parent = Content
NoClipBtn.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
NoClipBtn.BorderSizePixel = 0
NoClipBtn.Position = UDim2.new(0.05, 0, 0.55, 0)
NoClipBtn.Size = UDim2.new(0.9, 0, 0, 35)
NoClipBtn.Font = Enum.Font.GothamBold
NoClipBtn.Text = "üëª NOCLIP: OFF"
NoClipBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
NoClipBtn.TextSize = 12

local NoClipCorner = Instance.new("UICorner")
NoClipCorner.CornerRadius = UDim.new(0, 8)
NoClipCorner.Parent = NoClipBtn

-- Instant TP Button
local BaseTPBtn = Instance.new("TextButton")
BaseTPBtn.Parent = Content
BaseTPBtn.BackgroundColor3 = Color3.fromRGB(255, 69, 0)
BaseTPBtn.BorderSizePixel = 0
BaseTPBtn.Position = UDim2.new(0.05, 0, 0.8, 0)
BaseTPBtn.Size = UDim2.new(0.9, 0, 0, 28)
BaseTPBtn.Font = Enum.Font.GothamBold
BaseTPBtn.Text = "‚ö° INSTANT TP"
BaseTPBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
BaseTPBtn.TextSize = 12

local BaseTPCorner = Instance.new("UICorner")
BaseTPCorner.CornerRadius = UDim.new(0, 8)
BaseTPCorner.Parent = BaseTPBtn

-- TELEPORT FUNCTIONS (FIXED)
local function flyToDelivery()
    if teleporting then return end
    if not deliveryPosition then
        TeleportBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        TeleportBtn.Text = "‚ö†Ô∏è SET POSITION FIRST"
        spawn(function()
            wait(1.5)
            if TeleportBtn and TeleportBtn.Parent then
                TeleportBtn.BackgroundColor3 = Color3.fromRGB(65, 105, 225)
                TeleportBtn.Text = "üåÄ FLY TO POSITION"
            end
        end)
        return
    end
    
    local character = Player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not rootPart then return end
    
    teleporting = true
    TeleportBtn.Text = "üöÄ FLYING..."
    TeleportBtn.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
    
    -- Bypass anticheat
    if not bypassAnticheat(character) then
        teleporting = false
        return
    end
    
    -- Create smooth flying tween
    local targetCFrame = CFrame.new(deliveryPosition)
    local tweenInfo = TweenInfo.new(
        1.5, -- Duration
        Enum.EasingStyle.Quad,
        Enum.EasingDirection.InOut,
        0,
        false,
        0
    )
    
    local tween = TweenService:Create(rootPart, tweenInfo, {CFrame = targetCFrame})
    
    tween:Play()
    
    tween.Completed:Connect(function()
        restoreCharacter(character)
        TeleportBtn.Text = "‚úÖ ARRIVED!"
        TeleportBtn.BackgroundColor3 = Color3.fromRGB(50, 205, 50)
        
        spawn(function()
            wait(2)
            if TeleportBtn and TeleportBtn.Parent then
                TeleportBtn.Text = "üåÄ FLY TO POSITION"
                TeleportBtn.BackgroundColor3 = Color3.fromRGB(65, 105, 225)
            end
            teleporting = false
        end)
    end)
end

local function instantTeleport()
    if teleporting then return end
    if not deliveryPosition then
        BaseTPBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        BaseTPBtn.Text = "‚ö†Ô∏è SET POSITION FIRST"
        spawn(function()
            wait(1.5)
            if BaseTPBtn and BaseTPBtn.Parent then
                BaseTPBtn.BackgroundColor3 = Color3.fromRGB(255, 69, 0)
                BaseTPBtn.Text = "‚ö° INSTANT TP"
            end
        end)
        return
    end
    
    local character = Player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not rootPart then return end
    
    teleporting = true
    
    -- Show black screen
    TeleportScreen.Enabled = true
    BaseTPBtn.Text = "‚è≥ TELEPORTING..."
    BaseTPBtn.BackgroundColor3 = Color3.fromRGB(105, 105, 105)
    
    spawn(function()
        -- Bypass and teleport
        bypassAnticheat(character)
        
        wait(1) -- Black screen duration
        
        -- Instant teleport
        if rootPart and rootPart.Parent then
            rootPart.CFrame = CFrame.new(deliveryPosition)
        end
        
        wait(1) -- Additional delay
        
        -- Hide black screen
        TeleportScreen.Enabled = false
        
        -- Restore character
        restoreCharacter(character)
        
        BaseTPBtn.Text = "‚úÖ TELEPORTED!"
        BaseTPBtn.BackgroundColor3 = Color3.fromRGB(50, 205, 50)
        
        wait(2)
        if BaseTPBtn and BaseTPBtn.Parent then
            BaseTPBtn.Text = "‚ö° INSTANT TP"
            BaseTPBtn.BackgroundColor3 = Color3.fromRGB(255, 69, 0)
        end
        
        teleporting = false
    end)
end

-- NOCLIP SYSTEM (IMPROVED)
local function toggleNoClip()
    noclipEnabled = not noclipEnabled

    if noclipEnabled then
        NoClipBtn.Text = "üëª NOCLIP: ON"
        NoClipBtn.BackgroundColor3 = Color3.fromRGB(50, 205, 50)
        
        noclipConnection = RunService.Heartbeat:Connect(function()
            local character = Player.Character
            if character then
                for _, part in pairs(character:GetChildren()) do
                    if part:IsA("BasePart") and part ~= character.HumanoidRootPart then
                        part.CanCollide = false
                    end
                end
                
                -- Also handle accessories
                for _, accessory in pairs(character:GetChildren()) do
                    if accessory:IsA("Accessory") then
                        local handle = accessory:FindFirstChild("Handle")
                        if handle then
                            handle.CanCollide = false
                        end
                    end
                end
            end
        end)
    else
        NoClipBtn.Text = "üëª NOCLIP: OFF"
        NoClipBtn.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
        
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
        
        -- Restore collision
        local character = Player.Character
        if character then
            wait(0.1) -- Small delay to prevent glitching
            for _, part in pairs(character:GetChildren()) do
                if part:IsA("BasePart") and part ~= character.HumanoidRootPart then
                    part.CanCollide = true
                end
            end
            
            -- Restore accessory collision
            for _, accessory in pairs(character:GetChildren()) do
                if accessory:IsA("Accessory") then
                    local handle = accessory:FindFirstChild("Handle")
                    if handle then
                        handle.CanCollide = true
                    end
                end
            end
        end
    end
end

-- DRAG SYSTEM (FIXED)
local function enableDragging(frame)
    local dragging = false
    local dragStart = nil
    local startPos = nil
    local connection = nil

    local function updateInput(input)
        if dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end

    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            connection = UserInputService.InputChanged:Connect(updateInput)
        end
    end)

    Header.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
            if connection then
                connection:Disconnect()
                connection = nil
            end
        end
    end)
end

-- EVENTS (FIXED)
SetDeliveryBtn.MouseButton1Click:Connect(function()
    local character = Player.Character
    if character then
        local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
        if rootPart then
            deliveryPosition = rootPart.Position
            SetDeliveryBtn.BackgroundColor3 = Color3.fromRGB(50, 205, 50)
            SetDeliveryBtn.Text = "‚úÖ POSITION SET!"
            
            spawn(function()
                wait(2)
                if SetDeliveryBtn and SetDeliveryBtn.Parent then
                    SetDeliveryBtn.BackgroundColor3 = Color3.fromRGB(46, 139, 87)
                    SetDeliveryBtn.Text = "üìç SET POSITION"
                end
            end)
        end
    end
end)

TeleportBtn.MouseButton1Click:Connect(flyToDelivery)
BaseTPBtn.MouseButton1Click:Connect(instantTeleport)
NoClipBtn.MouseButton1Click:Connect(toggleNoClip)

MinimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    local targetSize = isMinimized and UDim2.new(0, 300, 0, 35) or UDim2.new(0, 300, 0, 180)
    
    local tween = TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {Size = targetSize})
    tween:Play()
    
    MinimizeBtn.Text = isMinimized and "+" or "‚àí"
    Content.Visible = not isMinimized
end)

CloseBtn.MouseButton1Click:Connect(function()
    if noclipConnection then 
        noclipConnection:Disconnect() 
        noclipConnection = nil
    end
    
    teleporting = false
    
    local tween = TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
        Size = UDim2.new(0, 0, 0, 0),
        Position = UDim2.new(0.5, 0, 0.5, 0)
    })
    
    tween:Play()
    
    tween.Completed:Connect(function()
        if ScreenGui and ScreenGui.Parent then
            ScreenGui:Destroy()
        end
        if TeleportScreen and TeleportScreen.Parent then
            TeleportScreen:Destroy()
        end
    end)
end)

-- Enable dragging
enableDragging(MainFrame)

print("‚ö° SIGMA HUB - Advanced Parkour Script Loaded!")
print("All features working perfectly!")
