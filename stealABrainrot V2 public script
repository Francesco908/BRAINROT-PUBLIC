-- LocalScript da inserire in StarterPlayerScripts
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local SoundService = game:GetService("SoundService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Variabili globali
local basePosition = Vector3.new(0, 5, 0)
local isActive = false
local gui, stealButton
local sound
local bodyVelocity, bodyPosition
local jumpConnection

-- Funzione per pulire le risorse
local function cleanup()
    if bodyVelocity then bodyVelocity:Destroy() end
    if bodyPosition then bodyPosition:Destroy() end
    if jumpConnection then jumpConnection:Disconnect() end
    isActive = false
end

-- Funzione per creare il suono
local function createSound()
    if sound then sound:Destroy() end
    
    sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://76714680193450"
    sound.Volume = 0.5
    sound.Looped = true
    sound.Parent = workspace
    sound:Play()
end

-- Funzione per creare la GUI
local function createGUI()
    if gui then gui:Destroy() end
    
    gui = Instance.new("ScreenGui")
    gui.Name = "AdminVsAdminGUI"
    gui.ResetOnSpawn = false
    gui.Parent = playerGui
    
    -- Scritta iniziale "made by Znfpro"
    local madeByLabel = Instance.new("TextLabel")
    madeByLabel.Name = "MadeByLabel"
    madeByLabel.Size = UDim2.new(0, 300, 0, 50)
    madeByLabel.Position = UDim2.new(0.5, -150, 0.5, -25)
    madeByLabel.BackgroundTransparency = 1
    madeByLabel.Text = "made by Znfpro"
    madeByLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    madeByLabel.TextScaled = true
    madeByLabel.Font = Enum.Font.GothamBold
    madeByLabel.TextTransparency = 1
    madeByLabel.Parent = gui
    
    -- Animazione scritta iniziale
    local fadeIn = TweenService:Create(madeByLabel, TweenInfo.new(1, Enum.EasingStyle.Quad), {TextTransparency = 0})
    local fadeOut = TweenService:Create(madeByLabel, TweenInfo.new(1, Enum.EasingStyle.Quad), {TextTransparency = 1})
    
    fadeIn:Play()
    fadeIn.Completed:Wait()
    task.wait(2)
    fadeOut:Play()
    fadeOut.Completed:Wait()
    madeByLabel:Destroy()
    
    -- Pulsante principale
    stealButton = Instance.new("TextButton")
    stealButton.Name = "StealButton"
    stealButton.Size = UDim2.new(0, 200, 0, 60)
    stealButton.Position = UDim2.new(0, 50, 0, 50)
    stealButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    stealButton.BorderSizePixel = 0
    stealButton.Text = "steal rainbow"
    stealButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    stealButton.TextScaled = true
    stealButton.Font = Enum.Font.GothamBold
    stealButton.Parent = gui
    
    -- Bordi arrotondati
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 15)
    corner.Parent = stealButton
    
    -- Effetto rainbow per il testo
    task.spawn(function()
        while stealButton and stealButton.Parent do
            for i = 0, 1, 0.01 do
                if stealButton and stealButton.Parent then
                    stealButton.TextColor3 = Color3.fromHSV(i, 1, 1)
                    task.wait(0.05)
                end
            end
        end
    end)
    
    -- Labels per "set base" e "steal"
    local setBaseLabel = Instance.new("TextLabel")
    setBaseLabel.Name = "SetBaseLabel"
    setBaseLabel.Size = UDim2.new(0, 150, 0, 30)
    setBaseLabel.Position = UDim2.new(0, 50, 0, 120)
    setBaseLabel.BackgroundTransparency = 1
    setBaseLabel.Text = "set base (B)"
    setBaseLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    setBaseLabel.TextScaled = true
    setBaseLabel.Font = Enum.Font.Gotham
    setBaseLabel.Visible = false
    setBaseLabel.Parent = gui
    
    local stealLabel = Instance.new("TextLabel")
    stealLabel.Name = "StealLabel"
    stealLabel.Size = UDim2.new(0, 150, 0, 30)
    stealLabel.Position = UDim2.new(0, 50, 0, 160)
    stealLabel.BackgroundTransparency = 1
    stealLabel.Text = "steal (click)"
    stealLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
    stealLabel.TextScaled = true
    stealLabel.Font = Enum.Font.Gotham
    stealLabel.Visible = false
    stealLabel.Parent = gui
    
    -- Mostra le labels in sequenza
    task.wait(0.5)
    setBaseLabel.Visible = true
    task.wait(1)
    stealLabel.Visible = true
end

-- Sistema di trascinamento
local function makeDraggable(frame)
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    local function update(input)
        if dragging and frame and frame.Parent then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end
    
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)
end

-- Sistema di movimento migliorato
local function startStealSequence()
    if isActive then return end
    isActive = true
    
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    
    if not humanoid or not rootPart then
        isActive = false
        return
    end

    cleanup()  -- Pulizia precedenti movimenti
    
    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.Parent = rootPart
    
    bodyPosition = Instance.new("BodyPosition")
    bodyPosition.MaxForce = Vector3.new(4000, 4000, 4000)
    bodyPosition.P = 3000
    bodyPosition.D = 500
    bodyPosition.Position = basePosition
    bodyPosition.Parent = rootPart
    
    -- Sistema di salti
    local jumpHeight = 50
    local jumpCount = 0
    local maxJumps = math.ceil((basePosition - rootPart.Position).Magnitude / 30)
    
    jumpConnection = RunService.Heartbeat:Connect(function()
        if not character:IsDescendantOf(workspace) then
            cleanup()
            return
        end
        
        local distance = (basePosition - rootPart.Position).Magnitude
        
        if distance > 5 and jumpCount < maxJumps then
            -- Salto automatico
            local jumpForce = Instance.new("BodyVelocity")
            jumpForce.MaxForce = Vector3.new(0, math.huge, 0)
            jumpForce.Velocity = Vector3.new(0, jumpHeight, 0)
            jumpForce.Parent = rootPart
            
            game:GetService("Debris"):AddItem(jumpForce, 0.5)
            jumpCount += 1
            task.wait(1.5)
        elseif distance <= 5 then
            cleanup()
            
            -- Messaggio di completamento
            local completionGui = Instance.new("TextLabel")
            completionGui.Size = UDim2.new(0, 300, 0, 60)
            completionGui.Position = UDim2.new(0.5, -150, 0.5, -30)
            completionGui.BackgroundTransparency = 1
            completionGui.Text = "RAINBOW STOLEN!"
            completionGui.TextColor3 = Color3.new(0, 1, 0)
            completionGui.TextScaled = true
            completionGui.Font = Enum.Font.GothamBold
            completionGui.TextTransparency = 0
            completionGui.Parent = gui
            
            local completionTween = TweenService:Create(completionGui, TweenInfo.new(2, Enum.EasingStyle.Quad), {TextTransparency = 1})
            completionTween:Play()
            completionTween.Completed:Connect(function()
                completionGui:Destroy()
            end)
        end
    end)
end

-- Funzione per impostare la base
local function setBase()
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    basePosition = rootPart.Position
    
    -- Feedback visivo
    local baseGui = Instance.new("TextLabel")
    baseGui.Size = UDim2.new(0, 300, 0, 40)
    baseGui.Position = UDim2.new(0.5, -150, 0.8, 0)
    baseGui.BackgroundTransparency = 1
    baseGui.Text = "Base position set!"
    baseGui.TextColor3 = Color3.fromRGB(255, 255, 0)
    baseGui.TextScaled = true
    baseGui.Font = Enum.Font.GothamBold
    baseGui.TextTransparency = 0
    baseGui.Parent = gui
    
    local baseTween = TweenService:Create(baseGui, TweenInfo.new(2, Enum.EasingStyle.Quad), {TextTransparency = 1})
    baseTween:Play()
    baseTween.Completed:Connect(function()
        baseGui:Destroy()
    end)
end

-- Inizializzazione principale
local function initialize()
    createSound()
    createGUI()
    
    if stealButton then
        makeDraggable(stealButton)
        
        -- Connessione eventi
        stealButton.MouseButton1Click:Connect(startStealSequence)
        stealButton.TouchTap:Connect(startStealSequence)
    end
    
    -- Tasto per impostare la base
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.B then
            setBase()
        end
    end)
end

-- Gestione cambiamento personaggio
player.CharacterAdded:Connect(function(character)
    character:WaitForChild("Humanoid").Died:Connect(cleanup)
    task.wait(1)  -- Attende il caricamento completo
    if not gui or not gui.Parent then
        initialize()
    end
end)

-- Avvio iniziale
if player.Character then
    initialize()
else
    player.CharacterAdded:Wait()
    initialize()
end
