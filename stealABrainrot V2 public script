-- LocalScript da inserire in StarterGui
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- Configurazione base
local BASE_POSITION = Vector3.new(0, 50, 0) -- Posizione della base
local FLY_SPEED = 100 -- Velocità di volo
local MAX_HEIGHT = 200 -- Altezza massima di volo
local COOLDOWN_TIME = 10 -- Cooldown in secondi

-- Stato del volo
local isFlying = false
local flyVelocity = Vector3.new(0, 0, 0)
local lastStealTime = 0

-- Creazione GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AdvancedFlyGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Pulsante Instant Steal
local stealButton = Instance.new("TextButton")
stealButton.Name = "InstantStealButton"
stealButton.Size = UDim2.new(0, 200, 0, 60)
stealButton.Position = UDim2.new(0.5, -100, 0.9, -30)
stealButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
stealButton.Text = "INSTANT STEAL"
stealButton.TextColor3 = Color3.new(1, 1, 1)
stealButton.TextScaled = true
stealButton.Font = Enum.Font.GothamBold
stealButton.Parent = screenGui

-- Decorazioni pulsante
local buttonStroke = Instance.new("UIStroke")
buttonStroke.Thickness = 3
buttonStroke.Color = Color3.new(1, 1, 1)
buttonStroke.Transparency = 0.3
buttonStroke.Parent = stealButton

local buttonShadow = Instance.new("Frame")
buttonShadow.Name = "Shadow"
buttonShadow.Size = UDim2.new(1, 10, 1, 10)
buttonShadow.Position = UDim2.new(0, 5, 0, 5)
buttonShadow.BackgroundColor3 = Color3.new(0, 0, 0)
buttonShadow.BackgroundTransparency = 0.5
buttonShadow.BorderSizePixel = 0
buttonShadow.ZIndex = stealButton.ZIndex - 1
buttonShadow.Parent = stealButton

-- Indicatore cooldown
local cooldownIndicator = Instance.new("Frame")
cooldownIndicator.Name = "CooldownIndicator"
cooldownIndicator.Size = UDim2.new(1, 0, 1, 0)
cooldownIndicator.Position = UDim2.new(0, 0, 0, 0)
cooldownIndicator.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
cooldownIndicator.BorderSizePixel = 0
cooldownIndicator.Parent = stealButton
cooldownIndicator.Visible = false

-- Funzione per creare effetti di volo
local function createFlyEffects(character)
    -- Trail effect
    local trail = Instance.new("Trail")
    trail.Attachment0 = Instance.new("Attachment", character.PrimaryPart)
    trail.Attachment1 = Instance.new("Attachment", character.PrimaryPart)
    trail.Attachment0.Position = Vector3.new(0, -1, 0)
    trail.Attachment1.Position = Vector3.new(0, 1, 0)
    trail.Color = ColorSequence.new(Color3.new(1, 0.5, 0))
    trail.Lifetime = 0.5
    trail.Transparency = NumberSequence.new(0, 1)
    trail.Parent = character.PrimaryPart
    
    -- Particle effect
    local particles = Instance.new("ParticleEmitter")
    particles.Texture = "rbxasset://textures/particles/sparkles_main.dds"
    particles.Color = ColorSequence.new(Color3.new(1, 0.8, 0), Color3.new(1, 0.2, 0))
    particles.Size = NumberSequence.new(0.5, 0)
    particles.Lifetime = NumberRange.new(1, 2)
    particles.Rate = 50
    particles.Speed = NumberRange.new(1, 3)
    particles.Parent = character.PrimaryPart
    
    -- Sound effect
    local flySound = Instance.new("Sound")
    flySound.SoundId = "rbxassetid://131961237" -- Suono di volo
    flySound.Looped = true
    flySound.Parent = character.PrimaryPart
    flySound:Play()
    
    return trail, particles, flySound
end

-- Funzione per iniziare il volo
local function startFly()
    if isFlying then return end
    if os.time() - lastStealTime < COOLDOWN_TIME then return end
    
    local character = player.Character
    if not character or not character.PrimaryPart then return end
    
    lastStealTime = os.time()
    isFlying = true
    
    -- Disabilita controlli normali
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = 0
        humanoid.JumpPower = 0
        humanoid.AutoRotate = false
    end
    
    -- Crea effetti
    local trail, particles, flySound = createFlyEffects(character)
    
    -- Mostra cooldown
    cooldownIndicator.Visible = true
    cooldownIndicator.Size = UDim2.new(1, 0, 1, 0)
    
    -- Animazione cooldown
    local cooldownTween = TweenService:Create(
        cooldownIndicator,
        TweenInfo.new(COOLDOWN_TIME, Enum.EasingStyle.Linear),
        {Size = UDim2.new(0, 0, 1, 0)}
    )
    cooldownTween:Play()
    cooldownTween.Completed:Connect(function()
        cooldownIndicator.Visible = false
    end)
    
    -- Calcola direzione verso la base
    local direction = (BASE_POSITION - character.PrimaryPart.Position).Unit
    local targetCFrame = CFrame.new(BASE_POSITION, BASE_POSITION + direction)
    
    -- Effetto visivo iniziale
    local flash = Instance.new("Frame")
    flash.Size = UDim2.new(1, 0, 1, 0)
    flash.BackgroundColor3 = Color3.new(1, 1, 1)
    flash.BackgroundTransparency = 1
    flash.ZIndex = 10
    flash.Parent = screenGui
    
    TweenService:Create(flash, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()
    game:GetService("Debris"):AddItem(flash, 0.6)
    
    -- Inizia volo
    local flyConnection
    flyConnection = RunService.Heartbeat:Connect(function(deltaTime)
        if not character or not character.PrimaryPart then
            flyConnection:Disconnect()
            return
        end
        
        -- Calcola nuova posizione
        local currentPos = character.PrimaryPart.Position
        local distance = (BASE_POSITION - currentPos).Magnitude
        
        if distance > 5 then
            -- Aggiorna velocità
            local moveDirection = (BASE_POSITION - currentPos).Unit
            flyVelocity = moveDirection * FLY_SPEED
            
            -- Applica movimento
            character.PrimaryPart.CFrame = CFrame.new(currentPos + flyVelocity * deltaTime, currentPos + moveDirection * 10)
            
            -- Limita altezza
            if currentPos.Y > MAX_HEIGHT then
                character.PrimaryPart.CFrame = CFrame.new(
                    Vector3.new(currentPos.X, MAX_HEIGHT, currentPos.Z),
                    character.PrimaryPart.CFrame.Position + moveDirection * 10
                )
            end
        else
            -- Atterraggio
            flyConnection:Disconnect()
            character.PrimaryPart.CFrame = targetCFrame
            
            -- Ripristina stato
            isFlying = false
            if humanoid then
                humanoid.WalkSpeed = 16
                humanoid.JumpPower = 50
                humanoid.AutoRotate = true
            end
            
            -- Rimuovi effetti
            trail:Destroy()
            particles:Destroy()
            flySound:Stop()
            flySound:Destroy()
            
            -- Effetto atterraggio
            local landFlash = Instance.new("Frame")
            landFlash.Size = UDim2.new(1, 0, 1, 0)
            landFlash.BackgroundColor3 = Color3.new(1, 0.8, 0)
            landFlash.BackgroundTransparency = 0.8
            landFlash.ZIndex = 10
            landFlash.Parent = screenGui
            
            TweenService:Create(landFlash, TweenInfo.new(0.5), {BackgroundTransparency = 1}):Play()
            game:GetService("Debris"):AddItem(landFlash, 0.6)
        end
    end)
end

-- Controlli di volo aggiuntivi
local function setupFlyControls()
    UserInputService.InputBegan:Connect(function(input)
        if isFlying and input.KeyCode == Enum.KeyCode.Space then
            -- Salto durante il volo
            local character = player.Character
            if character and character.PrimaryPart then
                character.PrimaryPart.CFrame = character.PrimaryPart.CFrame * CFrame.new(0, 10, 0)
            end
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if isFlying and input.UserInputType == Enum.UserInputType.MouseMovement then
            -- Rotazione durante il volo
            local character = player.Character
            if character and character.PrimaryPart then
                local delta = input.Delta
                character.PrimaryPart.CFrame = character.PrimaryPart.CFrame * CFrame.Angles(0, -delta.X * 0.01, 0)
            end
        end
    end)
end

-- Collega funzioni al pulsante
stealButton.MouseButton1Click:Connect(startFly)
stealButton.MouseEnter:Connect(function()
    TweenService:Create(stealButton, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(255, 100, 100),
        Size = UDim2.new(0, 210, 0, 65)
    }):Play()
end)

stealButton.MouseLeave:Connect(function()
    TweenService:Create(stealButton, TweenInfo.new(0.2), {
        BackgroundColor3 = Color3.fromRGB(255, 50, 50),
        Size = UDim2.new(0, 200, 0, 60)
    }):Play()
end)

-- Inizializza controlli di volo
setupFlyControls()

-- Notifica quando il giocatore entra nel gioco
player.CharacterAdded:Connect(function(character)
    -- Attendi che il personaggio sia completamente caricato
    character:WaitForChild("HumanoidRootPart")
    
    -- Mostra notifica
    local notification = Instance.new("TextLabel")
    notification.Size = UDim2.new(0, 300, 0, 50)
    notification.Position = UDim2.new(0.5, -150, 0.3, 0)
    notification.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    notification.Text = "Sistema di volo avanzato attivato!"
    notification.TextColor3 = Color3.new(1, 1, 1)
    notification.Font = Enum.Font.GothamBold
    notification.TextSize = 18
    notification.Parent = screenGui
    
    local notificationStroke = Instance.new("UIStroke")
    notificationStroke.Thickness = 2
    notificationStroke.Color = Color3.fromRGB(255, 150, 0)
    notificationStroke.Parent = notification
    
    TweenService:Create(notification, TweenInfo.new(0.5), {BackgroundTransparency = 0.3}):Play()
    game:GetService("Debris"):AddItem(notification, 3)
end)
