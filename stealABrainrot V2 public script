-- SISTEMA DI VOLO AVANZATO PER ROBLOX (MOBILE COMPATIBLE)
-- Inserisci questo script in ServerScriptService

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ContextActionService = game:GetService("ContextActionService")
local GuiService = game:GetService("GuiService")

-- Configurazione del sistema di volo
local FLIGHT_CONFIG = {
    MAX_SPEED = 200,
    ACCELERATION = 50,
    TURN_SPEED = 8,
    BOOST_MULTIPLIER = 2.5,
    DRAG = 0.85,
    LIFT_FORCE = 16.2,
    MOBILE_JOYSTICK_RADIUS = 100,
    MOBILE_BUTTON_SIZE = 80
}

-- Sistema di interfaccia mobile
local function createMobileControls(player)
    local playerGui = player:WaitForChild("PlayerGui")
    local touchGui = Instance.new("ScreenGui")
    touchGui.Name = "FlightMobileControls"
    touchGui.ResetOnSpawn = false
    touchGui.Parent = playerGui

    -- Joystick mobile
    local joystickFrame = Instance.new("Frame")
    joystickFrame.Name = "JoystickFrame"
    joystickFrame.Size = UDim2.new(0, FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS * 2, 0, FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS * 2)
    joystickFrame.Position = UDim2.new(0.1, 0, 0.7, 0)
    joystickFrame.BackgroundTransparency = 0.8
    joystickFrame.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
    joystickFrame.BorderSizePixel = 0
    joystickFrame.ClipsDescendants = true
    joystickFrame.Parent = touchGui

    local joystick = Instance.new("ImageButton")
    joystick.Name = "Joystick"
    joystick.Size = UDim2.new(0, FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS, 0, FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS)
    joystick.Position = UDim2.new(0.5, 0, 0.5, 0)
    joystick.AnchorPoint = Vector2.new(0.5, 0.5)
    joystick.BackgroundColor3 = Color3.new(1, 1, 1)
    joystick.BackgroundTransparency = 0.5
    joystick.Image = "rbxassetid://3570695787"
    joystick.ScaleType = Enum.ScaleType.Slice
    joystick.SliceCenter = Rect.new(100, 100, 100, 100)
    joystick.Parent = joystickFrame

    -- Pulsante Boost
    local boostButton = Instance.new("ImageButton")
    boostButton.Name = "BoostButton"
    boostButton.Size = UDim2.new(0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE, 0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE)
    boostButton.Position = UDim2.new(0.85, 0, 0.7, 0)
    boostButton.BackgroundTransparency = 1
    boostButton.Image = "rbxassetid://3926305904"
    boostButton.ImageRectOffset = Vector2.new(884, 4)
    boostButton.ImageRectSize = Vector2.new(36, 36)
    boostButton.Parent = touchGui

    -- Pulsante Volo
    local flightButton = Instance.new("ImageButton")
    flightButton.Name = "FlightButton"
    flightButton.Size = UDim2.new(0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE * 1.5, 0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE * 1.5)
    flightButton.Position = UDim2.new(0.5, 0, 0.85, 0)
    flightButton.AnchorPoint = Vector2.new(0.5, 0.5)
    flightButton.BackgroundTransparency = 1
    flightButton.Image = "rbxassetid://3926307971"
    flightButton.ImageRectOffset = Vector2.new(884, 4)
    flightButton.ImageRectSize = Vector2.new(36, 36)
    flightButton.Parent = touchGui

    -- Pulsanti Verticali
    local upButton = Instance.new("ImageButton")
    upButton.Name = "UpButton"
    upButton.Size = UDim2.new(0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE, 0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE)
    upButton.Position = UDim2.new(0.85, 0, 0.5, -FLIGHT_CONFIG.MOBILE_BUTTON_SIZE * 0.6)
    upButton.BackgroundTransparency = 1
    upButton.Image = "rbxassetid://3926305904"
    upButton.ImageRectOffset = Vector2.new(324, 124)
    upButton.ImageRectSize = Vector2.new(36, 36)
    upButton.Parent = touchGui

    local downButton = Instance.new("ImageButton")
    downButton.Name = "DownButton"
    downButton.Size = UDim2.new(0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE, 0, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE)
    downButton.Position = UDim2.new(0.85, 0, 0.5, FLIGHT_CONFIG.MOBILE_BUTTON_SIZE * 0.6)
    downButton.BackgroundTransparency = 1
    downButton.Image = "rbxassetid://3926305904"
    downButton.ImageRectOffset = Vector2.new(44, 364)
    downButton.ImageRectSize = Vector2.new(36, 36)
    downButton.Parent = touchGui

    return touchGui
end

-- Resto dello script rimane invariato fino alla funzione handleFlightControls...

-- Gestore input e controlli (versione mobile compatibile)
local function handleFlightControls(player, flightData, bodyVelocity, bodyAngularVelocity, effectsFolder)
    local character = player.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local camera = workspace.CurrentCamera
    
    -- Input tracking
    local keys = {
        W = false, A = false, S = false, D = false,
        Space = false, LeftShift = false,
        LeftControl = false, Q = false, E = false
    }
    
    -- Mobile input tracking
    local mobileInput = {
        JoystickPosition = Vector2.new(0, 0),
        BoostActive = false,
        UpActive = false,
        DownActive = false
    }
    
    -- Configurazione controlli mobile
    if UserInputService.TouchEnabled then
        local mobileGui = createMobileControls(player)
        
        -- Gestione joystick
        local joystickFrame = mobileGui:FindFirstChild("JoystickFrame")
        if joystickFrame then
            local joystick = joystickFrame:FindFirstChild("Joystick")
            local joystickPosition = Vector2.new(0, 0)
            local joystickActive = false
            
            local function updateJoystick(input)
                local touchPos = input.Position
                local center = joystickFrame.AbsolutePosition + joystickFrame.AbsoluteSize / 2
                local relative = (touchPos - center) / (FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS)
                
                if relative.Magnitude > 1 then
                    relative = relative.Unit
                end
                
                joystickPosition = relative
                joystick.Position = UDim2.new(
                    0.5, relative.X * FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS,
                    0.5, relative.Y * FLIGHT_CONFIG.MOBILE_JOYSTICK_RADIUS
                )
                
                mobileInput.JoystickPosition = Vector2.new(
                    -relative.Y,  -- Inverti Y per movimento naturale
                    relative.X
                )
            end
            
            joystickFrame.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    joystickActive = true
                    updateJoystick(input)
                end
            end)
            
            joystickFrame.InputChanged:Connect(function(input)
                if joystickActive and input.UserInputType == Enum.UserInputType.Touch then
                    updateJoystick(input)
                end
            end)
            
            joystickFrame.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    joystickActive = false
                    joystickPosition = Vector2.new(0, 0)
                    joystick.Position = UDim2.new(0.5, 0, 0.5, 0)
                    mobileInput.JoystickPosition = Vector2.new(0, 0)
                end
            end)
        end
        
        -- Gestione pulsanti
        local boostButton = mobileGui:FindFirstChild("BoostButton")
        if boostButton then
            boostButton.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    mobileInput.BoostActive = true
                    boostButton.ImageTransparency = 0.3
                end
            end)
            
            boostButton.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    mobileInput.BoostActive = false
                    boostButton.ImageTransparency = 0
                end
            end)
        end
        
        local upButton = mobileGui:FindFirstChild("UpButton")
        if upButton then
            upButton.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    mobileInput.UpActive = true
                    upButton.ImageTransparency = 0.3
                end
            end)
            
            upButton.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    mobileInput.UpActive = false
                    upButton.ImageTransparency = 0
                end
            end)
        end
        
        local downButton = mobileGui:FindFirstChild("DownButton")
        if downButton then
            downButton.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    mobileInput.DownActive = true
                    downButton.ImageTransparency = 0.3
                end
            end)
            
            downButton.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch then
                    mobileInput.DownActive = false
                    downButton.ImageTransparency = 0
                end
            end)
        end
        
        -- Pulsante attivazione volo
        local flightButton = mobileGui:FindFirstChild("FlightButton")
        if flightButton then
            flightButton.Activated:Connect(function()
                flightData.isFlying = not flightData.isFlying
                
                -- Effetti di attivazione
                if flightData.isFlying then
                    flightButton.ImageColor3 = Color3.fromRGB(0, 255, 255)
                    -- ... (attivazione effetti come nello script originale)
                else
                    flightButton.ImageColor3 = Color3.fromRGB(255, 255, 255)
                    -- ... (disattivazione effetti)
                end
            end)
        end
    else
        -- Controlli desktop (rimangono invariati)
        UserInputService.InputBegan:Connect(function(input, gameProcessed)
            -- ... (stesso codice originale per desktop)
        end)
        
        UserInputService.InputEnded:Connect(function(input, gameProcessed)
            -- ... (stesso codice originale per desktop)
        end)
    end
    
    -- Loop principale del volo (ottimizzato per mobile)
    local connection
    connection = RunService.Heartbeat:Connect(function(deltaTime)
        if not flightData.isFlying or not character.Parent then
            connection:Disconnect()
            return
        end
        
        -- Calcola direzione basata sulla camera
        local cameraCFrame = camera.CFrame
        local forward = cameraCFrame.LookVector
        local right = cameraCFrame.RightVector
        local up = cameraCFrame.UpVector
        
        -- Input processing (mobile + desktop)
        local moveVector = Vector3.new(0, 0, 0)
        
        -- Gestione input mobile
        if UserInputService.TouchEnabled then
            -- Joystick movement
            moveVector = moveVector + (forward * mobileInput.JoystickPosition.X)
            moveVector = moveVector + (right * mobileInput.JoystickPosition.Y)
            
            -- Vertical movement
            if mobileInput.UpActive then
                moveVector = moveVector + up
            end
            if mobileInput.DownActive then
                moveVector = moveVector - up
            end
            
            -- Boost
            flightData.isBoosting = mobileInput.BoostActive and flightData.energy > 0
        else
            -- Desktop movement (stesso codice originale)
            if keys.W then moveVector = moveVector + forward end
            if keys.S then moveVector = moveVector - forward end
            if keys.D then moveVector = moveVector + right end
            if keys.A then moveVector = moveVector - right end
            if keys.Space then moveVector = moveVector + up end
            if keys.LeftShift or keys.LeftControl then moveVector = moveVector - up end
            
            flightData.isBoosting = keys.Q and flightData.energy > 0
        end
        
        -- ... (resto del codice di volo invariato)
        
    end)
end

-- Il resto dello script rimane invariato...

print("ðŸš€ Sistema di Volo Avanzato Mobile Pronto!")
print("Controlli Mobile:")
print("- Joystick: Movimento Orizzontale")
print("- Pulsante SU/GIÃ™: Movimento Verticale")
print("- Pulsante BOOST: Attiva boost")
print("- Pulsante CENTRALE: Attiva/Disattiva Volo")
