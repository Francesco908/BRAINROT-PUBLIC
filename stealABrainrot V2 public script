-- Sigma Hub Ultimate V4 Optimized
-- Made by Znfpro

-- Attesa caricamento
if not game:IsLoaded() then game.Loaded:Wait() end

-- Cache servizi
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")

-- Variabili globali ottimizzate
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")
local Backpack = LocalPlayer:WaitForChild("Backpack")

local Settings = {
    basePosition = nil,
    isMovingToBase = false,
    speedEnabled = false,
    immortalActive = false,
    speedCoil = nil,
    speedCoilLocked = false
}

-- Bypass Anti-Cheat ottimizzato
local function InitializeBypass()
    local mt = getrawmetatable(game)
    local old_namecall = mt.__namecall
    local old_index = mt.__index
    local old_newindex = mt.__newindex
    
    setreadonly(mt, false)
    
    -- Namecall bypass
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        
        -- Blocca kick/ban
        if method == "Kick" or method == "Destroy" then
            return wait(9e9)
        end
        
        -- Blocca remotes anti-cheat
        if (method == "FireServer" or method == "InvokeServer") then
            local name = tostring(self):lower()
            if name:match("kick") or name:match("ban") or name:match("anti") or 
               name:match("cheat") or name:match("exploit") then
                return wait(9e9)
            end
        end
        
        -- Blocca damage se immortale
        if Settings.immortalActive and method == "TakeDamage" then
            return nil
        end
        
        -- Mantieni Speed Coil
        if Settings.speedCoilLocked and method == "UnequipTools" then
            return nil
        end
        
        return old_namecall(self, ...)
    end)
    
    -- Index bypass
    mt.__index = newcclosure(function(self, key)
        if tostring(self) == "Humanoid" then
            if key == "WalkSpeed" then return 16 end
            if key == "JumpPower" then return 50 end
            if Settings.immortalActive and key == "Health" then return 100 end
        end
        return old_index(self, key)
    end)
    
    -- Newindex bypass
    mt.__newindex = newcclosure(function(self, key, value)
        if tostring(self) == "Humanoid" then
            if Settings.speedEnabled then
                if key == "WalkSpeed" and value < 250 then return end
                if key == "JumpPower" and value < 200 then return end
            end
            if Settings.immortalActive and key == "Health" and value < self.MaxHealth then
                return
            end
        end
        return old_newindex(self, key, value)
    end)
    
    setreadonly(mt, true)
    
    -- Disabilita connections anti-cheat
    local connections = {
        Humanoid.Changed,
        Humanoid:GetPropertyChangedSignal("WalkSpeed"),
        Humanoid:GetPropertyChangedSignal("JumpPower")
    }
    
    for _, signal in pairs(connections) do
        for _, connection in pairs(getconnections(signal)) do
            connection:Disable()
        end
    end
end

-- Crea GUI ottimizzata
local function CreateGUI()
    local GUI = Instance.new("ScreenGui")
    GUI.Name = HttpService:GenerateGUID(false):gsub("-", "")
    GUI.ResetOnSpawn = false
    
    -- Protezione GUI
    if syn and syn.protect_gui then
        syn.protect_gui(GUI)
        GUI.Parent = game:GetService("CoreGui")
    else
        GUI.Parent = LocalPlayer.PlayerGui
    end
    
    -- Container principale
    local Container = Instance.new("Frame")
    Container.Size = UDim2.new(0.2, 0, 0.22, 0)
    Container.Position = UDim2.new(0.78, 0, 0.1, 0)
    Container.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    Container.Active = true
    Container.Draggable = true
    Container.Parent = GUI
    
    -- UI Corner
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 10)
    UICorner.Parent = Container
    
    -- Header
    local Header = Instance.new("TextLabel")
    Header.Size = UDim2.new(1, 0, 0.25, 0)
    Header.BackgroundTransparency = 1
    Header.Text = "SIGMA HUB"
    Header.TextColor3 = Color3.new(1, 1, 1)
    Header.TextScaled = true
    Header.Font = Enum.Font.Gotham
    Header.Parent = Container
    
    -- Base Button
    local BaseButton = Instance.new("TextButton")
    BaseButton.Size = UDim2.new(0.9, 0, 0.25, 0)
    BaseButton.Position = UDim2.new(0.05, 0, 0.3, 0)
    BaseButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    BaseButton.Text = "Set Base"
    BaseButton.TextColor3 = Color3.new(1, 1, 1)
    BaseButton.TextScaled = true
    BaseButton.Font = Enum.Font.SourceSans
    BaseButton.Parent = Container
    
    Instance.new("UICorner", BaseButton).CornerRadius = UDim.new(0, 5)
    
    -- Speed Button
    local SpeedButton = Instance.new("TextButton")
    SpeedButton.Size = UDim2.new(0.9, 0, 0.25, 0)
    SpeedButton.Position = UDim2.new(0.05, 0, 0.6, 0)
    SpeedButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    SpeedButton.Text = "Speed OFF"
    SpeedButton.TextColor3 = Color3.fromRGB(255, 0, 0)
    SpeedButton.TextScaled = true
    SpeedButton.Font = Enum.Font.SourceSans
    SpeedButton.Parent = Container
    
    Instance.new("UICorner", SpeedButton).CornerRadius = UDim.new(0, 5)
    
    -- Logo fade
    task.spawn(function()
        local Logo = Instance.new("TextLabel")
        Logo.Size = UDim2.new(0.3, 0, 0.1, 0)
        Logo.Position = UDim2.new(0.35, 0, 0.45, 0)
        Logo.BackgroundTransparency = 1
        Logo.Text = "Made by Znfpro"
        Logo.TextColor3 = Color3.new(1, 1, 1)
        Logo.TextScaled = true
        Logo.Font = Enum.Font.Gotham
        Logo.Parent = GUI
        
        for i = 1, 0, -0.05 do
            Logo.TextTransparency = i
            task.wait(0.03)
        end
        task.wait(2)
        for i = 0, 1, 0.05 do
            Logo.TextTransparency = i
            task.wait(0.03)
        end
        Logo:Destroy()
    end)
    
    return {
        BaseButton = BaseButton,
        SpeedButton = SpeedButton
    }
end

-- Funzioni ottimizzate
local function FindSpeedCoil()
    for _, tool in pairs(Backpack:GetChildren()) do
        if tool:IsA("Tool") and tool.Name:lower():match("speed") then
            return tool
        end
    end
    for _, tool in pairs(Character:GetChildren()) do
        if tool:IsA("Tool") and tool.Name:lower():match("speed") then
            return tool
        end
    end
    return nil
end

local function SetImmortal(enabled)
    Settings.immortalActive = enabled
    if enabled then
        local immortalLoop
        immortalLoop = RunService.Heartbeat:Connect(function()
            if not Settings.immortalActive then
                immortalLoop:Disconnect()
                return
            end
            Humanoid.MaxHealth = math.huge
            Humanoid.Health = math.huge
            if RootPart.Position.Y < -500 then
                RootPart.CFrame = Settings.basePosition or CFrame.new(0, 100, 0)
            end
        end)
    else
        Humanoid.MaxHealth = 100
        Humanoid.Health = 100
    end
end

local function ActivateSpeed()
    Settings.speedCoil = FindSpeedCoil()
    
    if not Settings.speedCoil then
        StarterGui:SetCore("SendNotification", {
            Title = "Sigma Hub",
            Text = "You don't have Speed Coil in your backpack!",
            Duration = 3
        })
        return false
    end
    
    Settings.speedEnabled = true
    Settings.speedCoilLocked = true
    
    -- Speed loop ottimizzato
    local speedLoop
    speedLoop = RunService.Heartbeat:Connect(function()
        if not Settings.speedEnabled then
            speedLoop:Disconnect()
            return
        end
        
        -- Mantieni Speed Coil equipaggiato
        if Settings.speedCoil.Parent ~= Character then
            Humanoid:EquipTool(Settings.speedCoil)
        end
        
        -- Applica velocitÃ 
        Humanoid.WalkSpeed = 250
        Humanoid.JumpPower = 200
        
        -- Velocity boost
        if Humanoid.MoveDirection.Magnitude > 0 then
            RootPart.AssemblyLinearVelocity = Humanoid.MoveDirection * 250
        end
    end)
    
    return true
end

local function GoToBase()
    if not Settings.basePosition then return end
    
    Settings.isMovingToBase = true
    SetImmortal(true)
    
    if not Settings.speedEnabled then
        ActivateSpeed()
    end
    
    -- Movimento ottimizzato
    task.spawn(function()
        while Settings.isMovingToBase do
            local distance = (Settings.basePosition.Position - RootPart.Position).Magnitude
            
            if distance < 5 then
                Settings.isMovingToBase = false
                RootPart.CFrame = Settings.basePosition
                
                task.wait(2)
                SetImmortal(false)
                
                StarterGui:SetCore("SendNotification", {
                    Title = "Sigma Hub",
                    Text = "Arrived at base! Immortality OFF",
                    Duration = 2
                })
                break
            end
            
            -- Movimento veloce
            local direction = (Settings.basePosition.Position - RootPart.Position).Unit
            RootPart.CFrame = RootPart.CFrame + (direction * 15)
            
            task.wait()
        end
    end)
end

-- Setup principale
InitializeBypass()
local GUI_Elements = CreateGUI()

-- Button handlers
GUI_Elements.BaseButton.MouseButton1Click:Connect(function()
    if GUI_Elements.BaseButton.Text == "Set Base" then
        Settings.basePosition = RootPart.CFrame
        GUI_Elements.BaseButton.Text = "Go to Base"
        
        StarterGui:SetCore("SendNotification", {
            Title = "Sigma Hub",
            Text = "Base position saved!",
            Duration = 2
        })
    else
        GoToBase()
    end
end)

GUI_Elements.SpeedButton.MouseButton1Click:Connect(function()
    if not Settings.speedEnabled then
        if ActivateSpeed() then
            GUI_Elements.SpeedButton.Text = "Speed ON"
            GUI_Elements.SpeedButton.TextColor3 = Color3.fromRGB(0, 255, 0)
        end
    else
        Settings.speedEnabled = false
        Settings.speedCoilLocked = false
        GUI_Elements.SpeedButton.Text = "Speed OFF"
        GUI_Elements.SpeedButton.TextColor3 = Color3.fromRGB(255, 0, 0)
        
        Humanoid.WalkSpeed = 16
        Humanoid.JumpPower = 50
    end
end)

-- Anti-kick ottimizzato
task.spawn(function()
    while true do
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(60)
    end
end)

-- Character respawn handler
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid")
    RootPart = newChar:WaitForChild("HumanoidRootPart")
    Backpack = LocalPlayer:WaitForChild("Backpack")
    
    task.wait(1)
    InitializeBypass()
    
    if Settings.speedEnabled then
        ActivateSpeed()
    end
end)

print("Sigma Hub V4 Optimized - Loaded Successfully!")
